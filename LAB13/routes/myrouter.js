const express = require('express');
const router = express.Router();

const connectDB = require("../config/db"); // ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•


//‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Multer ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î options
const multer = require('multer')

const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        cb(null, './public/images/products') //file part
    },
    filename: function (req, file, cb) {
        cb(null, Date.now() + ".jpg") //auto filename
    }
})

const upload = multer({
    storage: storage
})

//‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Model
const Product = require('../models/products');
const Member = require('../models/members');
const Sale = require('../models/sales');

const title = "ITMI Shop";

router.get("/", async (req, res) => {
    try {
        const products = await Product.find(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å DB
        res.render("index", {products: products, title: title}); // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà index.ejs
    } catch (error) {
        res.status(500).json({message: "Server Error", error: error.message});
    }
});

router.get('/addForm', (req, res) => {
    const title = "Add New Product";
    res.render('form', {title: title});
})

router.get('/manage', async (req, res) => {
    const title = "Manage Product";
    // console.log('Session ID: ', req.sessionID)
    // console.log('Session Data: ', req.session)

    if (req.session.login) {
        try {
            const products = await Product.find();
            res.render("manage", {products: products, title: title});
        } catch (error) {
            res.status(500).json({message: "Server Error", error: error.message});
        }
    } else {
        res.redirect('/login')
    }

})

router.post('/insert', upload.single("image"), async (req, res) => {
    // console.log(req.body);
    try {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const newProduct = new Product({
            name: req.body.name,
            price: req.body.price,
            image: req.file.filename,
            description: req.body.description
        });
        const savedProduct = await newProduct.save();
        res.redirect('/');

        //res.status(201).json({ message: "Product added", product: savedProduct });

    } catch (error) {
        res.status(500).json({message: "Server Error", error: error.message});
    }
});

router.get('/delete/:id', async (req, res) => {
    //console.log("Deltete ID: ", req.params.id);
    try {
        Product.findByIdAndDelete(req.params.id, {useFindAndModify: false}).exec();
        res.redirect('/manage');
    } catch (error) {
        res.status(500).json({message: "Server Error", error: error.message});
    }
})

// üîπ Route ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡πâ‡∏≠‡∏ô
router.get("/findindex", async (req, res) => {
    res.render('find');
});

router.get("/find", async (req, res) => {
    try {
        let query = {};

        if (req.query.name) {
            query.name = {$eq: req.query.name}; // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô
        }
        if (req.query.minPrice) {
            query.price = {...query.price, $gte: parseInt(req.query.minPrice)}; // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö
        }
        if (req.query.maxPrice) {
            query.price = {...query.price, $lte: parseInt(req.query.maxPrice)}; // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö
        }
        if (req.query.exclude) {
            query.name = {$ne: req.query.exclude}; // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        }
        if (req.query.highPriceOnly) {
            query.price = {$gt: 5000}; // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 5000
        }
        if (req.query.lowPriceOnly) {
            query.price = {$lt: 2000}; // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 2000
        }

        const products = await Product.find(query);
        res.render("findResults", {products, title: "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"});

    } catch (error) {
        res.status(500).send("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
    }
});

router.get('/search', async (req, res) => {
    try {
        let minPrice = req.query.min ? parseFloat(req.query.min) : 0;
        let maxPrice = req.query.max ? parseFloat(req.query.max) : Number.MAX_VALUE;

        //console.log(minPrice, maxPrice);
        let products = await Product.find({
            price: {$gte: minPrice, $lte: maxPrice}
        });
        //console.log(products);
        res.render("index", {products: products, title: title});

    } catch (error) {
        res.status(500).json({message: "Server Error", error: error.message});
    }

});

router.post('/edit', async (req, res) => {
    const title = "Edit Product";
    try {
        const edit_id = req.body.id;
        //console.log(edit_id);
        product = await Product.findOne({_id: edit_id}).exec();
        //console.log(product);
        res.render('formedit', {product: product, title: title});

    } catch (error) {
        res.status(500).json({message: "Server Error", error: error.message});
    }
});

router.post('/update', upload.single("image"), async (req, res) => {
    try {
        const id = req.body.id;
        const data = {
            name: req.body.name,
            price: req.body.price,
            description: req.body.description
        };
        if (req.file) {
            data.image = req.file.filename;
        }

        // console.log("‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ", id);
        // console.log("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ", data);

        await Product.findByIdAndUpdate(id, data, {useFindAndModify: false}).exec();
        await res.redirect('/manage');

    } catch (error) {
        res.status(500).json({message: "Server Error", error: error.message});
    }
});

// üìå ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
router.get("/sales/all", async (req, res) => {
    if (req.session.login) {
        const sales = await Sale.find().populate("product").populate("member");
        res.render("sales/showsale", {sales});
    } else {
        res.redirect('/login')
    }
});

// üìå ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
router.get("/sales/new", async (req, res) => {
    if (req.session.login) {
        const products = await Product.find();
        const members = await Member.find();
        res.render("sales/newsale", {products, members});
    } else {
        res.redirect('/login')
    }
});

router.get('/indexapi', (req, res) => {
    res.render('indexapi', {title: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (API)", products: []});
})

router.get('/api/products', async (req, res) => {
    try {
        let filter = {}
        const {min, max} = req.body

        if (min && max) {
            filter.price = {$gte: parseInt(min), $lte: parseInt(max)}
        }

        const products = await Product.find(filter)
        res.json(products)
    } catch (e) {
        res.status(500).json({message: "Server Error", error: e.message})
    }
})

router.get('/regisapi', (req, res) => {
    res.render('register/regisapi')
})

router.get('/productapi', (req, res) => {
    res.render('product/addproductapi', {title: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"})
})

router.post('/api/register', async (req, res) => {
    try {
        const {name, email, phone, password, confirmPassword} = req.body;

        if (password !== confirmPassword) {
            return res.status(400).json({message: "Password do not match"})
        }

        const hashedPassword = await bcrypt.hash(password, 10);
        const newUser = new Member({name, email, phone, password: hashedPassword})

        await newUser.save()
        res.status(201).json({message: "Register Success"})
    } catch (err) {
        res.status(500).json({message: "Server Error", error: err.message})
    }
})

router.post('/api/product', upload.single("image"), async (req, res) => {
    console.log(req.body)
    try {
        const newProduct = new Product({
            name: req.body.name,
            price: req.body.price,
            image: req.file.filename,

            description: req.body.description
        });
        await newProduct.save();
        res.status(201).json({message: "Product added"});
    } catch (error) {
        res.status(500).json({message: "Server Error", error: error.message});
    }
})

// üìå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
router.post("/sales/insert", async (req, res) => {
    const {product, member, quantity} = req.body;

    const productData = await Product.findById(product);
    const totalPrice = productData.price * quantity;

    const newSale = new Sale({
        product,
        member,
        quantity,
        totalPrice
    });

    await newSale.save();
    res.redirect("/sales/all");
});

// üìå ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
const moment = require('moment');

router.get("/sales/report", async (req, res) => {
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• startDate ‡πÅ‡∏•‡∏∞ endDate ‡∏à‡∏≤‡∏Å query parameters
    const {startDate, endDate} = req.query;

    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    let filter = {};
    if (startDate && endDate) {
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        const start = moment(startDate).startOf('day').toDate();
        const end = moment(endDate).endOf('day').toDate();

        filter.date = {$gte: start, $lte: end};
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const sales = await Sale.find(filter).populate("product").populate("member");

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    let totalSales = 0;
    sales.forEach(sale => {
        totalSales += sale.totalPrice;
    });

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    res.render("sales/report", {sales, totalSales, startDate, endDate});
});

const bcrypt = require("bcryptjs");

// üìå ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
router.get("/register", (req, res) => {
    res.render("register/regisindex");
});

// üìå ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (POST)
router.post("/register", async (req, res) => {
    const {name, email, phone, password, confirmPassword} = req.body;

    // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (password !== confirmPassword) {
        return res.render("register/regisindex", {error: "Passwords do not match"});
    }

    try {
        // ‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        const hashedPassword = await bcrypt.hash(password, 10);

        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà
        const newMember = new Member({
            name,
            email,
            phone,
            password: hashedPassword, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß
        });

        await newMember.save();
        res.redirect("/"); // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    } catch (error) {
        console.error(error);
        res.render("register/regisindex", {error: "Error registering user"});
    }
});

// üìå Route ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Login
router.get("/login", (req, res) => {
    res.render("login", {message: req.session.message});
});

// üìå Route ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Login
router.post("/login", async (req, res) => {
    const {email, password} = req.body;
    const user = await Member.findOne({email});

    if (!user || !(await user.comparePassword(password))) {
        req.session.message = "Invalid email or password!";
        return res.redirect("/login");
    }

    req.session.user = user;
    req.session.login = true;
    req.session.cookie.maxAge = 60000 * 5;
    res.redirect("/dashboard");
});

// üìå Route ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Dashboard (‡∏´‡∏•‡∏±‡∏á Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
router.get("/dashboard", (req, res) => {
    if (!req.session.user) {
        return res.redirect("/login");
    }
    res.render("dashboard", {user: req.session.user});
});

// üìå Route Logout
router.get("/logout", (req, res) => {
    req.session.destroy(() => {
        res.redirect("/login");
    });
});


router.get('/:id', async (req, res) => {
    const title = "Product Detail";
    try {
        const product_id = req.params.id;
        product = await Product.findOne({_id: product_id}).exec();

        //console.log(product);
        res.render("product", {product: product, title: title});

    } catch (error) {
        res.status(500).json({message: "Server Error", error: error.message});
    }
})


module.exports = router;


